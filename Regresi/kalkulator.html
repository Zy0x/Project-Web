<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <title>Kalkulator Analisis Regresi</title>
    <link rel="icon" href="/assets/images/favicon.png" type="image/png">
    <script src="https://cdn.jsdelivr.net/npm/chart.js "></script>
    <!-- Load MathJax untuk menampilkan notasi matematika -->
    <script id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
    <style>

    <style>
        /* Reset */
        @font-face {
            font-family: 'Lexend';
            src: url('assets/fonts/Lexend-VariableFont_wght.ttf') format('opentype');
        }
        @font-face {
            font-family: 'Josefin Sans';
            src: url('assets/fonts/JosefinSans-VariableFont_wght.ttf') format('opentype');
        }
        @font-face {
            font-family: Montserrat;
            src: url('assets/fonts/Montserrat-VariableFont_wght.ttf') format('opentype');
        }
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        body {
            font-family: Arial, sans-serif;
            background-color: #f4f4f9;
            display: flex;
            justify-content: center;
            align-items: flex-start;
            min-height: 100vh;
            padding: 20px;
            font-family: Montserrat, sans-serrif;
        }
        .container {
            width: 100%;
            max-width: 900px;
            background: white;
            border-radius: 10px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
            padding: 30px;
            overflow-y: auto;
        }
        h1 {
            font-family: Lexend, sans-serif;
            text-align: center;
            margin-bottom: 25px;
            font-size: 1.8em;
            color: #333;
        }
        h2, h3 {
            font-family: Josefin Sans, sans-serif;
            color: #333;
        }
        label {
            display: block;
            margin-top: 15px;
            font-weight: bold;
            font-size: 1em;
        }
        input[type="number"],
        input[type="text"],
        input[type="password"] {
            width: 100%;
            padding: 10px 12px;
            margin-top: 5px;
            border: 1px solid #ccc;
            border-radius: 6px;
            font-size: 1em;
            font-family: Montserrat, sans-serif;
        }
        button {
            margin-top: 20px;
            padding: 12px 20px;
            background-color: #007bff;
            color: white;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 1em;
            width: 100%;
            transition: background-color 0.3s ease;
            font-family: Montserrat, sans-serif;
        }
        button:hover {
            background-color: #0056b3;
        }
        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }
        th {
            border: 1px solid black;
            padding: 10px;
            text-align: center;
        }
        td {
            border: 1px solid black;
            padding: 10px;
            text-align: center;
            white-space: nowrap;
        }
        .deviation-row {
            background-color: #e0f7fa; /* Warna biru muda */
            font-weight: bold;
        }
        .scrollable-table-container {
            overflow-x: auto;
            -webkit-overflow-scrolling: touch;
            margin-top: 15px;
            width: 100%;
        }
         .input-table td input {
            text-align: center;
        }       
        .penyelesaian {
            margin-top: 25px;
            font-size: 14px;
            line-height: 1.6;
            display: none;
            overflow-x: auto; /* Tambahkan scroll horizontal */
            -webkit-overflow-scrolling: touch; /* Agar smooth scroll di iOS */
        }

        /* Gaya tambahan untuk scrollbar (opsional tapi estetis) */
        .penyelesaian::-webkit-scrollbar {
            height: 8px;
        }

        .penyelesaian::-webkit-scrollbar-track {
            background: #f1f1f1;
        }

        .penyelesaian::-webkit-scrollbar-thumb {
            background: #ccc;
            border-radius: 4px;
        }
        .penyelesaian h3 {
            margin-bottom: 10px;
            font-size: 1.2em;
        }
        .result-card {
            background-color: #ffffff;
            border-left: 5px solid #007bff;
            padding: 20px;
            margin-top: 25px;
            border-radius: 8px;
            box-shadow: 0 2px 6px rgba(0, 0, 0, 0.05);
        }

        .result-card h2 {
            color: #2c3e50;
            font-size: 1.4em;
            margin-bottom: 15px;
            font-family: 'Lexend', sans-serif;
        }

        .result-card p {
            font-size: 1em;
            line-height: 1.6;
            margin-bottom: 10px;
            color: #333;
        }

        .equation {
            color: #007bff;
            font-weight: bold;
        }

        .equation-wrapper {
            position: relative;
            display: inline-block;
            width: 100%;
        }

        .equation-highlight {
            background-color: #fff3cd;
            border-left: 4px solid #ffc107;
            padding: 15px 20px;
            margin: 20px 0;
            color: #856404;
            font-weight: bold;
            font-family: 'Josefin Sans', sans-serif;
            font-size: clamp(1.2em, 4vw, 2em);
            white-space: nowrap;
            overflow-x: auto; /* Aktifkan scroll horizontal */
            text-align: center;
            display: block;
            max-width: 100%;
        }
        .equation-highlight::-webkit-scrollbar {
            height: 6px;
        }

        .equation-highlight::-webkit-scrollbar-track {
            background: #f1f1f1;
        }

        .equation-highlight::-webkit-scrollbar-thumb {
            background: #ccc;
            border-radius: 3px;
        }
        .expand-btn {
            position: absolute;
            right: 10px;
            top: 50%;
            transform: translateY(-50%);
            background: none;
            border: none;
            color: #007bff;
            font-size: 0.9em;
            cursor: pointer;
            display: none;
        }

        details.step-card {
            transition: max-height 0.3s ease-out;
            overflow: hidden;
        }

        details.step-card[open] {
            animation: fadeIn 0.3s ease-in;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(-5px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .correlation {
            color: #2e7d32;
            font-weight: bold;
        }

        .determination {
            color: #6a1b9a;
            font-weight: bold;
        }
        .step-card {
            background-color: #ffffff;
            border-radius: 10px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
            margin-bottom: 15px;
            overflow: hidden;
            transition: transform 0.2s ease, box-shadow 0.2s ease;
        }

        .step-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 16px rgba(0, 0, 0, 0.1);
        }

        .icon-arrow {
            font-size: 1.2em;
            transition: transform 0.3s ease;
            color: #888;
            min-width: 1.2em; /* Agar ikon tidak menggeser teks saat animasi */
            text-align: center;
        }

        .step-card[open] .icon-arrow {
            transform: rotate(90deg);
            color: #007bff;
        }
        .step-header {
            font-size: 1em;
            font-weight: bold;
            color: #2c3e50;
            padding: 15px 20px;
            cursor: pointer;
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: linear-gradient(to right, #f8f9fa, #fff);
            position: relative;
            border-left: 5px solid #007bff;
        }
        .step-header summary {
            outline: none;
        }
        .step-title {
            flex-grow: 1;
            white-space: nowrap; /* Agar teks tetap satu baris */
            overflow: hidden;
            text-overflow: ellipsis;
            margin-right: 10px; /* Jarak antara teks dan ikon */
            display: flex;
            align-items: center;
        }

        .step-content {
            padding: 15px 20px;
            font-size: 0.95em;
            line-height: 1.6;
            background-color: #fbfbfb;
            border-top: 1px solid #eee;
            overflow-x: auto;
            -webkit-overflow-scrolling: touch;
            text-align: left; /* Pastikan teks rata kiri */
        }

        /* Agar rumus MathJax juga rata kiri */
        .step-content p, .step-content ul, .step-content li, .step-content table {
            text-align: left !important;
            margin-left: 0 !important;
        }

        .MathJax {
            text-align: left !important;
            display: block !important;
        }

        .MathJax_Display {
            text-align: left !important;
            display: block !important;
        }
        .step-content::-webkit-scrollbar {
            height: 6px;
        }

        .step-content::-webkit-scrollbar-track {
            background: #f1f1f1;
        }

        .step-content::-webkit-scrollbar-thumb {
            background: #ccc;
            border-radius: 3px;
        }

        .step-content .math-alignment {
            display: block;
            margin-left: 20px;
            font-family: 'Josefin Sans', sans-serif;
        }

        .step-content p {
            margin: 0;
        }

        .interpretation-card .step-content {
            white-space: normal;
            overflow-x: visible;
        }
        input:focus {
            border-color: #007bff;
            box-shadow: 0 0 0 2px rgba(0, 123, 255, 0.25);
        }
        #regression-chart {
            width: 100%;
            height: auto;
            aspect-ratio: 16 / 9;
            margin-top: 25px;
            max-height: 500px;
            border: 1px solid #ddd;
            border-radius: 10px;
            background-color: #fafafa;
        }

        @media (max-width: 600px) {
            .container {
                padding: 15px;
            }
            input,
            button {
                font-size: 0.95em;
            }
        }
    </style>
</head>
<body>
<div id="calculator" class="container">
    <h1>Kalkulator Analisis Regresi</h1>

    <!-- Calculator Form -->
    <div id="calculator-form">
        <label for="n">Banyak Data (n)</label>
        <input type="number" id="n" min="2" required onkeypress="handleNKeyPress(event)" />
        <small id="error-n" style="color: red; font-size: 0.9em; display: none;">
            Minimal data yang diperlukan adalah 2.
        </small>
        <label for="decimal">Jumlah Angka di Belakang Koma</label>
        <input type="number" id="decimal" min="0" />
        <small id="warning-decimal" style="color: #666; font-size: 0.7em;">*Kosongkan jika ingin menampilkan seluruh angka di belakang koma</small>
        <div id="error-decimal" style="display: none; color: red; font-size: 0.9em; margin-top: 5px;"></div>
        <label for="varX">Nama Variabel X</label>
        <input type="text" id="varX" placeholder="Contoh: Jumlah Jam Belajar" required />
        <small style="color: #666; font-size: 0.7em;">*Variabel yang mempengaruhi</small>
        <label for="varY">Nama Variabel Y</label>
        <input type="text" id="varY" placeholder="Contoh: Nilai Ujian" required />
        <small style="color: #666; font-size: 0.7em;">*Variabel yang dipengaruhi</small>
        <button id="reset-btn" style="display: none; margin-top: 10px;" onclick="resetForm()">Reset Tabel</button>
        <div id="action-buttons"></div>
        <div id="data-input"></div>
        <button id="calculate-btn" style="display: none;" onclick="calculateRegression()">Hitung</button>
        <div id="results" style="margin-top: 30px;"></div>
    </div>
</div>

<script>
    const isLoggedIn = localStorage.getItem('isLoggedIn');

    if (!isLoggedIn || isLoggedIn !== 'true') {
        // Jika belum login, arahkan ke halaman login
        window.location.href = 'login.html';
    }

    // Fungsi logout (opsional)
    function logout() {
        localStorage.removeItem('isLoggedIn');
        window.location.href = 'login.html';
    }
    function debounce(func, delay) {
        let timer;
        return function (...args) {
            clearTimeout(timer);
            timer = setTimeout(() => func.apply(this, args), delay);
        };
    }
    function setupBasicEnterNavigation() {
        const fields = ['n', 'decimal', 'varX', 'varY'];
        fields.forEach((id, index) => {
            const element = document.getElementById(id);
            if (element) {
                element.addEventListener('keydown', function (e) {
                    if (e.key === 'Enter') {
                        e.preventDefault();
                        if (index < fields.length - 1) {
                            document.getElementById(fields[index + 1])?.focus();
                        }
                    }
                });
            }
        });
    }
    function setupEnterNavigation() {
        const container = document.getElementById('data-input');
        if (!container) return;

        function handleEnter(e) {
            const id = e.target.id;
            const match = id.match(/([xy])(\d+)/);
            if (!match || e.key !== 'Enter') return;
            e.preventDefault();

            const type = match[1];
            const num = parseInt(match[2]);
            const max = parseInt(document.getElementById('n').value);

            if (type === 'x') {
                const nextX = document.getElementById(`x${num + 1}`);
                if (nextX) {
                    nextX.focus();
                } else {
                    const firstY = document.getElementById('y1');
                    if (firstY) firstY.focus();
                }
            } else if (type === 'y') {
                const nextY = document.getElementById(`y${num + 1}`);
                if (nextY) {
                    nextY.focus();
                } else {
                    calculateRegression(); // Hitung otomatis saat Enter di Yn
                }
            }
        }

        // Pasang event listener ke semua input di dalam data-input
        container.querySelectorAll('input').forEach(input => {
            input.removeEventListener('keydown', handleEnter); // Hindari duplikasi
            input.addEventListener('keydown', debounce(handleEnter, 200));
        });
    }
    function autoGenerateInputTable() {
        const nInput = document.getElementById('n');
        const varXInput = document.getElementById('varX');
        const varYInput = document.getElementById('varY');

        function tryGenerate() {
            const n = parseInt(nInput.value);
            if (!isNaN(n) && n >= 2) {
                generateInputTable();
            }
        }

        [nInput, varXInput, varYInput].forEach(input => {
            input.addEventListener('input', tryGenerate);
        });
    }

    function generateInputTable() {
        const nInput = document.getElementById('n');
        const n = parseInt(nInput.value);
        const varX = document.getElementById('varX').value.trim() || "X";
        const varY = document.getElementById('varY').value.trim() || "Y";
        const container = document.getElementById('data-input');

        // Hapus pesan error lama jika ada
        const existingError = document.getElementById('error-n');
        if (existingError) existingError.remove();

        // Validasi minimal 2 data
        if (isNaN(n) || n < 2) {
            const errorMsg = document.createElement('div');
            errorMsg.id = 'error-n';
            errorMsg.style.color = 'red';
            errorMsg.style.fontSize = '0.9em';
            errorMsg.style.marginTop = '5px';
            errorMsg.innerText = 'Minimal data yang diperlukan adalah 2.';
            nInput.parentNode.insertBefore(errorMsg, nInput.nextSibling);
            return; // Hentikan eksekusi jika invalid
        }

        // Jika valid, lanjutkan membuat tabel
        container.innerHTML = '';
        let tableHTML = `<table class="input-table" id="data-table"><tr><th>No.</th><th id="header-x">${varX}</th><th id="header-y">${varY}</th></tr>`;
        for (let i = 1; i <= n; i++) {
            tableHTML += `<tr><td>${i}</td><td><input type="number" id="x${i}" step="any"></td><td><input type="number" id="y${i}" step="any"></td></tr>`;
        }
        tableHTML += `</table>`;
        container.innerHTML = tableHTML;
        document.getElementById('calculate-btn').style.display = 'block';

        // Setelah tabel dibuat, tambahkan listener untuk update header secara real-time
        setupVariableNameListeners();
        setupEnterNavigation(); // ⬅️ TAMBAHKAN DI SINI
    }

    function validateAndGenerate() {
        const nInput = document.getElementById('n');
        const n = parseInt(nInput.value);
        const container = document.getElementById('data-input');

        // Hapus error lama jika ada
        const existingError = document.getElementById('error-n');
        if (existingError) existingError.remove();

        // Jika n tidak valid (< 2), tampilkan error dan hapus tabel
        if (isNaN(n) || n < 2) {
            const errorMsg = document.createElement('div');
            errorMsg.id = 'error-n';
            errorMsg.style.color = 'red';
            errorMsg.style.fontSize = '0.9em';
            errorMsg.style.marginTop = '5px';
            errorMsg.innerText = 'Minimal data yang diperlukan adalah 2.';
            nInput.parentNode.insertBefore(errorMsg, nInput.nextSibling);

            // Hapus tabel jika sudah dibuat
            container.innerHTML = '';
            document.getElementById('calculate-btn').style.display = 'none';

            return;
        }

        // Jika valid, generate tabel
        generateInputTable();
    }
    function setupVariableNameListeners() {
        const varXInput = document.getElementById('varX');
        const varYInput = document.getElementById('varY');

        varXInput.addEventListener('input', () => {
            const headerX = document.getElementById('header-x');
            const newValue = varXInput.value.trim() || "X";
            if (headerX) headerX.textContent = newValue;
        });

        varYInput.addEventListener('input', () => {
            const headerY = document.getElementById('header-y');
            const newValue = varYInput.value.trim() || "Y";
            if (headerY) headerY.textContent = newValue;
        });
    }
    function formatNumber(num, decimal) {
        let number = parseFloat(num);

        // Jika num NaN atau invalid, kembalikan 0 atau sesuai preferensi
        if (isNaN(number)) return '0';

        // Jika decimal tidak ditentukan atau negatif, gunakan semua desimal tanpa pembulatan
        if (isNaN(decimal) || decimal === null || decimal < 0) {
            return number.toString().replace('.', ',');
        }

        // Bulatkan ke jumlah desimal yang diminta
        let fixedStr = number.toFixed(decimal);
        let parts = fixedStr.split('.');
        let integerPart = parts[0] || '0';
        let decimalPart = parts[1] || '';

        // Hapus nol di akhir
        decimalPart = decimalPart.replace(/0+$/, '');

        // Jika tidak ada angka desimal, kembalikan hanya bagian bulat
        if (decimalPart === '') {
            return integerPart;
        }

        // Gabungkan dan ganti titik dengan koma
        return `${integerPart},${decimalPart}`;
    }

    function calculateRegression() {
        // Hapus pesan error lama (jika ada)
        const existingError = document.getElementById('error-empty-fields');
        if (existingError) existingError.remove();

        const n = parseInt(document.getElementById('n').value);
        const decimalInput = document.getElementById('decimal').value;
        const decimal = parseInt(decimalInput);
        const varX = document.getElementById('varX').value.trim() || "X";
        const varY = document.getElementById('varY').value.trim() || "Y";

        let xValues = [];
        let yValues = [];

        // Validasi: Pastikan semua field X dan Y sudah diisi
        let allFilled = true;
        let firstEmpty = null;

        for (let i = 1; i <= n; i++) {
            const xVal = document.getElementById(`x${i}`).value.trim();
            const yVal = document.getElementById(`y${i}`).value.trim();

            if (xVal === '' || yVal === '') {
                allFilled = false;
                if (!firstEmpty) {
                    firstEmpty = xVal === '' ? `x${i}` : `y${i}`;
                }
                break; // Berhenti loop jika ketemu yang kosong
            }
        }

        if (!allFilled) {
            // Tampilkan pesan error
            const errorMsg = document.createElement('div');
            errorMsg.id = 'error-empty-fields';
            errorMsg.style.color = 'red';
            errorMsg.style.fontSize = '0.9em';
            errorMsg.style.marginTop = '10px';
            errorMsg.innerText = 'Semua kolom X dan Y harus diisi sebelum menghitung.';
            document.getElementById('calculate-btn').parentNode.appendChild(errorMsg);

            // Fokus ke field pertama yang kosong
            if (firstEmpty) {
                document.getElementById(firstEmpty).focus();
            }

            return; // Hentikan eksekusi fungsi
        }

        // Ambil nilai X dan Y
        for (let i = 1; i <= n; i++) {
            xValues.push(parseFloat(document.getElementById(`x${i}`).value));
            yValues.push(parseFloat(document.getElementById(`y${i}`).value));
        }

        // Hitung rata-rata
        const xBar = xValues.reduce((a, b) => a + b, 0) / n;
        const yBar = yValues.reduce((a, b) => a + b, 0) / n;

        // Hitung SSxx, SSyy, SSxy
        let ssxx = 0, ssyy = 0, ssxy = 0;
        for (let i = 0; i < n; i++) {
            ssxx += Math.pow(xValues[i] - xBar, 2);
            ssyy += Math.pow(yValues[i] - yBar, 2);
            ssxy += (xValues[i] - xBar) * (yValues[i] - yBar);
        }

        // Hitung koefisien regresi
        const b = ssxy / ssxx;
        const a = yBar - b * xBar;

        // Hitung korelasi & determinasi
        const r = ssxy / Math.sqrt(ssxx * ssyy);
        const rSquared = Math.pow(r, 2);

        // Menentukan tingkat korelasi
        let tingkatKorelasi = '';
        const absR = Math.abs(r);
        if (absR === 0) {
            tingkatKorelasi = 'Tidak Berkorelasi';
        } else if (absR > 0 && absR <= 0.3) {
            tingkatKorelasi = 'Lemah';
        } else if (absR > 0.3 && absR <= 0.7) {
            tingkatKorelasi = 'Sedang/Cukup';
        } else if (absR > 0.7 && absR < 1) {
            tingkatKorelasi = 'Kuat';
        } else if (absR === 1) {
            tingkatKorelasi = 'Sempurna';
        }

        // Format persentase
        function toPercentage(value, decimal) {
            const percent = value * 100;
            let formatted;
            if (percent % 1 === 0) {
                formatted = percent.toString();
            } else {
                formatted = parseFloat(percent).toFixed(decimal).replace('.', ',');
            }
            return formatted;
        }
        // Fungsi untuk membuat card pertama terbuka secara otomatis
        function stepOpenStatus(stepNumber) {
            return stepNumber === 1 ? 'open' : '';
        }
        // Buat hasil dalam HTML
        const resultsDiv = document.getElementById('results');
        resultsDiv.innerHTML = `
            <div class="result-card">
                <h2>Hasil Perhitungan</h2>
                <p><strong>Persamaan Regresi:</strong></p>
                ${b >= 0 ? 
                    `<div class="equation-highlight">Ŷ = ${formatNumber(a, decimal)} + ${formatNumber(b, decimal)}X</div>` : 
                    `<div class="equation-highlight">Ŷ = ${formatNumber(a, decimal)} - ${formatNumber(Math.abs(b), decimal)}X</div>`
                }
                <p><b>Koefisien Korelasi (r)</b> sebesar <b>${formatNumber(r, decimal)}</b> (${toPercentage(r, decimal)}%), 
                dengan Tingkat Korelasi <b>${tingkatKorelasi}</b> dan 
                <b>Koefisien Determinasi (r²)</b> sebesar <b>${formatNumber(rSquared, decimal)}</b> (${toPercentage(rSquared, decimal)}%).</p>
            </div>
            <div class="scrollable-table-container">
                <table>
                    <tr>
                        <th class="deviation-row">
                            ${varX}${document.getElementById('varX').value.trim() ? '<br><span style="font-size: 0.8em; font-weight: bold;">(X)</span>' : ''}
                        </th>
                        <th class="deviation-row">
                            ${varY}${document.getElementById('varY').value.trim() ? '<br><span style="font-size: 0.8em; font-weight: bold;">(Y)</span>' : ''}
                        </th>
                        <td class="deviation-row">(X - X̄)</td>
                        <td class="deviation-row">(Y - Ȳ)</td>
                        <td class="deviation-row">(X - X̄)²</td>
                        <td class="deviation-row">(Y - Ȳ)²</td>
                        <td class="deviation-row">(X - X̄)(Y - Ȳ)</td>
                    </tr>
                    ${xValues.map((x, i) => `
                        <tr>
                            <td>${formatNumber(x, decimal)}</td>
                            <td>${formatNumber(yValues[i], decimal)}</td>
                            <td>${formatNumber(x - xBar, decimal)}</td>
                            <td>${formatNumber(yValues[i] - yBar, decimal)}</td>
                            <td>${formatNumber(Math.pow(x - xBar, 2), decimal)}</td>
                            <td>${formatNumber(Math.pow(yValues[i] - yBar, 2), decimal)}</td>
                            <td>${formatNumber((x - xBar) * (yValues[i] - yBar), decimal)}</td>
                        </tr>
                    `).join('')}
                </table>
            </div>
            <button id="show-steps-btn" onclick="showPenyelesaian()">Tampilkan Penyelesaian</button>
            <div id="penyelesaian" class="penyelesaian">
                <h3>Langkah-Langkah Penyelesaian</h3>
                <!-- LANGKAH 1 -->
                <details class="step-card" ${stepOpenStatus(1)}>
                <summary class="step-header">
                    <span class="step-title">1. Menghitung Rata-Rata (\\( \\bar{X} \\) dan \\( \\bar{Y} \\))</span>
                    <span class="icon-arrow">➤</span>
                </summary>                    
                <div class="step-content">
                        <p>\\[ \\bar{X} = \\frac{\\sum X}{n} = \\frac{${xValues.map(x => formatNumber(x, decimal)).join('+')}}{${n}} = ${formatNumber(xBar, decimal)} \\]</p>
                        <p>\\[ \\bar{Y} = \\frac{\\sum Y}{n} = \\frac{${yValues.map(y => formatNumber(y, decimal)).join('+')}}{${n}} = ${formatNumber(yBar, decimal)} \\]</p>
                    </div>
                </details>
                <!-- LANGKAH 2 -->
                <details class="step-card" ${stepOpenStatus(2)}>
                    <summary class="step-header">2. Menghitung SSxx, SSyy, dan SSxy<span class="icon-arrow"> ➤</span></summary>
                    <div class="step-content">
                        <p>\\[ SS_{xx} = \\sum{(X - \\bar{X})^2} = ${xValues.map(x => `( ${formatNumber(x - xBar, decimal)} )^2`).join(' + ')} = ${formatNumber(ssxx, decimal)} \\]</p>
                        <p>\\[ SS_{yy} = \\sum{(Y - \\bar{Y})^2} = ${yValues.map(y => `( ${formatNumber(y - yBar, decimal)} )^2`).join(' + ')} = ${formatNumber(ssyy, decimal)} \\]</p>
                        <p>\\[ SS_{xy} = \\sum{(X - \\bar{X})(Y - \\bar{Y})} = ${xValues.map((x, i) => `( ${formatNumber(x - xBar, decimal)} )( ${formatNumber(yValues[i] - yBar, decimal)} )`).join(' + ')} = ${formatNumber(ssxy, decimal)} \\]</p>
                        
                        <div style="margin:20px 0; padding:15px; border-left:5px solid #007bff; background:#f8f9fa; border-radius:4px;">
                            <h4 style="color:#007bff; margin-top:0;">Apa itu SSxx, SSyy, dan SSxy?</h4>
                            <ul style="padding-left: 20px; list-style: none; line-height:1.6; margin:0;">
                                <li><strong>SSxx</strong>: Selisih kuadrat antara nilai <em>X</em> dengan rata-rata <em>X</em>.</li>
                                <li><strong>SSyy</strong>: Selisih kuadrat antara nilai <em>Y</em> dengan rata-rata <em>Y</em>.</li>
                                <li><strong>SSxy</strong>: Selisih hasil perkalian simpangan <em>X</em> dan simpangan <em>Y</em>.</li>
                            </ul>
                        </div>
                    </div>
                </details>
                <!-- LANGKAH 3 -->
                <details class="step-card" ${stepOpenStatus(3)}>
                    <summary class="step-header">3. Menghitung Koefisien Regresi (b dan a)<span class="icon-arrow"> ➤</span></summary>
                    <div class="step-content">
                        <!-- Rumus Koefisien Regresi b -->
                        <p><strong>\\( b = \\frac{SS_{xy}}{SS_{xx}} = \\frac{${formatNumber(ssxy, decimal)}}{${formatNumber(ssxx, decimal)}} = ${formatNumber(b, decimal)} \\)</strong></p>

                        <!-- PENJELASAN NILAI b -->
                        <div style="margin:20px 0; padding:15px; border-left:5px solid #007bff; background:#f8f9fa; border-radius:4px;">
                            <h4 style="color:#007bff; margin-top:0;">Apa itu Nilai <strong>b</strong>?</h4>
                            <ul style="padding-left: 0; list-style: none; line-height:1.6; margin:0;">
                                <p style="margin:0; padding:0 0 8px 0;"><strong>Nilai b = ${formatNumber(b, decimal)}</strong></p>
                                <p style="margin:0; padding:0 0 8px 0;">Artinya, setiap peningkatan 1 satuan pada <em>${varX}</em>, maka nilai <em>${varY}</em> akan berubah sebesar <strong>${formatNumber(b, decimal)}</strong>.</p>
                                <li style="margin:0; padding:0 0 8px 20px;">Jika <strong>b positif (+)</strong>, semakin besar X (<em>${varX}</em>) → Y (<em>${varY}</em>) juga semakin besar.</li>
                                <li style="margin:0; padding:0 0 8px 20px;">Jika <strong>b negatif (−)</strong>, semakin besar X (<em>${varX}</em>) → Y (<em>${varY}</em>) malah semakin kecil.</li>
                            </ul>
                        </div>

                        <!-- Rumus Intersept a -->
                        <p><strong>\\( a = \\bar{Y} - b\\bar{X} = ${formatNumber(yBar, decimal)} - (${formatNumber(b, decimal)} \\times ${formatNumber(xBar, decimal)}) = ${formatNumber(a, decimal)} \\)</strong></p>

                        <!-- PENJELASAN NILAI a -->
                        <div style="margin:20px 0; padding:15px; border-left:5px solid #28a745; background:#f8f9fa; border-radius:4px;">
                            <h4 style="color:#28a745; margin-top:0;">Apa itu Nilai <strong>a</strong>?</h4>
                            <ul style="padding-left: 0; line-height:1.6; margin:0;">
                                <p style="margin:0; padding:0 0 8px 0;"><strong>Nilai a = ${formatNumber(a, decimal)}</strong></p>
                                <p style="margin:0; padding:0 0 8px 0;">Nilai <strong>a</strong> merepresentasikan titik potong sumbu Y dari garis regresi, yaitu prediksi nilai Y (<em>${varY}</em>) ketika nilai X (<em>${varX}</em>) sama dengan nol.</p>
                                <p style="margin:0; padding:0 0 8px 0;">Artinya, saat <em>${varX}</em> bernilai nol, maka perkiraan nilai <em>${varY}</em> adalah sekitar <strong>${formatNumber(a, decimal)}</strong>.</p>
                                <p style="margin:0; padding:0 0 8px 0;"><strong>Catatan:</strong> Interpretasi ini hanya valid jika dalam konteks data, X=0 memiliki makna nyata (misalnya, jam belajar = 0).</p>
                            </ul>
                        </div>
                    </div>
                </details>
                <!-- LANGKAH 4 -->
                <details class="step-card" ${stepOpenStatus(4)}>
                    <summary class="step-header">4. Persamaan Regresi Linier<span class="icon-arrow"> ➤</span></summary>
                    <div class="step-content">
                        <p>\\[ Ŷ = a + bX = 
                            ${b >= 0 ? 
                                `${formatNumber(a, decimal)} + ${formatNumber(b, decimal)}X` : 
                                `${formatNumber(a, decimal)} - ${formatNumber(Math.abs(b), decimal)}X`
                            }
                        \\]</p>
                    </div>
                </details>
                <!-- LANGKAH 5 -->
                <details class="step-card" ${stepOpenStatus(5)}>
                    <summary class="step-header">5. Menghitung Koefisien Korelasi (r)<span class="icon-arrow"> ➤</span></summary>
                    <div class="step-content">
                        <p>\\[ r = \\frac{SS_{xy}}{\\sqrt{SS_{xx} \\cdot SS_{yy}}} = \\frac{${formatNumber(ssxy, decimal)}}{\\sqrt{${formatNumber(ssxx, decimal)} \\cdot ${formatNumber(ssyy, decimal)}}} = ${formatNumber(r, decimal)} \\]</p>
                    </div>
                </details>
                <!-- LANGKAH 6 -->
                <details class="step-card" ${stepOpenStatus(6)}>
                    <summary class="step-header">6. Menghitung Koefisien Determinasi (r²)<span class="icon-arrow"> ➤</span></summary>
                    <div class="step-content">
                        <p>\\[ r^2 = r \\cdot r = ${formatNumber(r, decimal)} \\cdot ${formatNumber(r, decimal)} = ${formatNumber(rSquared, decimal)} \\]</p>
                    </div>
                </details>
                <!-- INTERPRETASI -->
                <details class="step-card interpretation-card" ${stepOpenStatus(7)}>
                    <summary class="step-header">7. Interpretasi Hasil<span class="icon-arrow"> ➤</span></summary>
                    <div class="step-content">
                        <ul>
                            <li>Koefisien korelasi sebesar <strong>${formatNumber(r, decimal)}</strong>, menunjukkan hubungan antara variabel X dan Y dengan tingkat korelasi <strong>${tingkatKorelasi}</strong>.</li>
                            <li>Koefisien determinasi sebesar <strong>${formatNumber(rSquared, decimal)}</strong>, artinya sekitar <strong>${toPercentage(rSquared, decimal)}%</strong> variasi pada variabel Y dapat dijelaskan oleh variabel X melalui model regresi linier ini.</li>
                        </ul>
                    </div>
                </details>
            </div>
            <canvas id="regression-chart"></canvas>
        `;

        renderRegressionChart(xValues, yValues, a, b);
    }
    function checkAllFieldsFilled() {
        const n = parseInt(document.getElementById('n').value);
        let allFilled = true;

        for (let i = 1; i <= n; i++) {
            const xVal = document.getElementById(`x${i}`).value.trim();
            const yVal = document.getElementById(`y${i}`).value.trim();
            if (xVal === '' || yVal === '') {
                allFilled = false;
                break;
            }
        }

        const calculateBtn = document.getElementById('calculate-btn');
        if (allFilled) {
            calculateBtn.style.display = 'inline-block';
        } else {
            calculateBtn.style.display = 'none';
        }
    }
    function showPenyelesaian() {
        const penyelesaianDiv = document.getElementById('penyelesaian');
        const toggleBtn = document.getElementById('show-steps-btn');
        if (penyelesaianDiv.style.display === 'none' || penyelesaianDiv.style.display === '') {
            penyelesaianDiv.style.display = 'block';
            toggleBtn.innerText = 'Sembunyikan Penyelesaian';
            MathJax.typeset(); // Pastikan rumus matematika dirender ulang
        } else {
            penyelesaianDiv.style.display = 'none';
            toggleBtn.innerText = 'Tampilkan Penyelesaian';
        }
    }

    function setupAutoCalculateOnDecimalChange() {
        const decimalInput = document.getElementById('decimal');

        function handleDecimalChange() {
            const decimalValue = decimalInput.value.trim();

            // Hapus error/warning lama
            const errorDiv = document.getElementById('error-decimal');
            const warningDiv = document.getElementById('warning-decimal');
            errorDiv.style.display = 'none';
            warningDiv.style.display = 'block';

            if (!decimalValue) return;

            const parsedDecimal = parseInt(decimalValue);

            if (parsedDecimal < 0) {
                errorDiv.textContent = 'Tidak boleh kurang dari 0.';
                errorDiv.style.color = 'red';
                errorDiv.style.display = 'block';
                warningDiv.style.display = 'none';
            } else if (parsedDecimal === 0) {
                warningDiv.textContent = 'Menggunakan 0 angka di belakang koma dapat mempengaruhi keakuratan hasil.';
                warningDiv.style.color = '#e67e22'; // warna kuning/oranye
                warningDiv.style.backgroundColor = '#fff9c4';
                warningDiv.style.padding = '5px';
                warningDiv.style.borderRadius = '4px';
                warningDiv.style.display = 'block';
            } else {
                warningDiv.textContent = '*Kosongkan jika ingin menampilkan seluruh angka di belakang koma';
                warningDiv.style.color = '#666';
                warningDiv.style.backgroundColor = 'transparent';
                warningDiv.style.padding = '';
                warningDiv.style.borderRadius = '';
            }

            // Cek apakah semua input X dan Y terisi
            const n = parseInt(document.getElementById('n').value);
            let allFilled = true;
            for (let i = 1; i <= n; i++) {
                const xVal = document.getElementById(`x${i}`).value.trim();
                const yVal = document.getElementById(`y${i}`).value.trim();
                if (xVal === '' || yVal === '') {
                    allFilled = false;
                    break;
                }
            }

            if (allFilled && !isNaN(parsedDecimal) && parsedDecimal >= 0) {
                calculateRegression(); // Hitung ulang otomatis
            }
        }

        decimalInput.addEventListener('input', handleDecimalChange);
    }
    document.getElementById('decimal').addEventListener('input', debounce(function () {
        const decimalInput = this.value.trim();
        const errorDiv = document.getElementById('error-decimal');
        const warningDiv = document.getElementById('warning-decimal');

        errorDiv.style.display = 'none';
        warningDiv.style.display = 'block';

        if (!decimalInput) return;

        const decimalValue = parseInt(decimalInput);

        if (decimalValue < 0) {
            errorDiv.textContent = 'Tidak boleh kurang dari 0.';
            errorDiv.style.color = 'red';
            errorDiv.style.display = 'block';
            warningDiv.style.display = 'none';
        } else if (decimalValue === 0) {
            warningDiv.textContent = 'Menggunakan 0 angka di belakang koma dapat mempengaruhi keakuratan hasil.';
            warningDiv.style.color = '#e67e22';
            warningDiv.style.padding = '5px';
            warningDiv.style.borderRadius = '4px';
            warningDiv.style.display = 'block';
        } else {
            warningDiv.textContent = '*Kosongkan jika ingin menampilkan seluruh angka di belakang koma';
            warningDiv.style.color = '#666';
            warningDiv.style.backgroundColor = 'transparent';
            warningDiv.style.padding = '';
            warningDiv.style.borderRadius = '';
        }

        // Cek apakah semua data X dan Y terisi
        const n = parseInt(document.getElementById('n').value);
        let allFilled = true;
        for (let i = 1; i <= n; i++) {
            const xVal = document.getElementById(`x${i}`).value.trim();
            const yVal = document.getElementById(`y${i}`).value.trim();
            if (xVal === '' || yVal === '') {
                allFilled = false;
                break;
            }
        }

        if (allFilled && !isNaN(decimalValue) && decimalValue >= 0) {
            calculateRegression(); // Hitung ulang otomatis
        }

    }, 300));
    function renderRegressionChart(xValues, yValues, a, b) {
        const ctx = document.getElementById('regression-chart').getContext('2d');

        // Hapus chart lama jika ada
        if (window.regressionChartInstance) {
            window.regressionChartInstance.destroy();
        }

        window.regressionChartInstance = new Chart(ctx, {
            type: 'scatter',
            data: {
                datasets: [
                    {
                        label: 'Data Asli',
                        data: xValues.map((x, i) => ({ x: x, y: yValues[i] })),
                        backgroundColor: 'rgba(75, 192, 192, 0.6)',
                        borderColor: 'rgba(75, 192, 192, 1)',
                        pointRadius: 5
                    },
                    {
                        label: 'Garis Regresi',
                        data: xValues.map(x => ({ x: x, y: a + b * x })),
                        type: 'line',
                        borderColor: 'rgba(255, 99, 132, 1)',
                        borderWidth: 2,
                        fill: false
                    }
                ]
            },
            options: {
                responsive: true,
                maintainAspectRatio: true,
                aspectRatio: 16 / 9,
                scales: {
                    x: { 
                        type: 'linear', 
                        position: 'bottom', 
                        title: { display: true, text: 'X' } 
                    },
                    y: { 
                        title: { display: true, text: 'Y' } 
                    }
                },
                plugins: {
                    legend: { display: true, position: 'top' },
                    tooltip: {
                        callbacks: {
                            label: context => `(${context.parsed.x}, ${context.parsed.y})`
                        }
                    }
                }
            }
        });
    }
    let isDataModified = false;

    // Contoh: Deteksi input pengguna
    document.getElementById('n').addEventListener('input', () => {
        isDataModified = true;
    });

    window.addEventListener('beforeunload', function (e) {
        if (isDataModified) {
            const message = 'Anda yakin ingin meninggalkan halaman ini? Data yang belum disimpan mungkin akan hilang.';
            e.preventDefault();
            e.returnValue = message;
        }
    });

    function setupResetButtonVisibility() {
        const resetBtn = document.getElementById('reset-btn');

        // Fungsi pengecekan apakah ada input x/y terisi
        function checkIfInputsFilled() {
            const n = parseInt(document.getElementById('n').value);
            if (isNaN(n) || n < 2) return;

            for (let i = 1; i <= n; i++) {
                const xVal = document.getElementById(`x${i}`)?.value.trim();
                const yVal = document.getElementById(`y${i}`)?.value.trim();
                if (xVal !== '' || yVal !== '') {
                    resetBtn.style.display = 'inline-block';
                    return;
                }
            }

            // Jika belum ada yang terisi, sembunyikan tombol
            resetBtn.style.display = 'none';
        }

        // Pasang event listener ke semua input tabel
        document.getElementById('data-input').addEventListener('input', debounce(checkIfInputsFilled, 200));
    }

    // Panggil fungsi ini saat DOM dimuat
    window.addEventListener('DOMContentLoaded', () => {
        setupEnterNavigation();
        setupBasicEnterNavigation(); // 🔥 Tambahkan ini
        autoGenerateInputTable();
        setupAutoCalculateOnDecimalChange();
        setupResetButtonVisibility();
        document.getElementById('n').addEventListener('input', debounce(function () {
            validateAndGenerate();
        }, 300));
    });

    function resetForm() {
        const confirmation = confirm("Anda yakin ingin mereset tabel? Semua data input akan hilang.");
        if (!confirmation) return;

        // Ambil jumlah data saat ini
        const n = parseInt(document.getElementById('n').value);
        if (isNaN(n) || n < 2) return;

        // Kosongkan semua input X dan Y
        for (let i = 1; i <= n; i++) {
            const xInput = document.getElementById(`x${i}`);
            const yInput = document.getElementById(`y${i}`);
            if (xInput) xInput.value = '';
            if (yInput) yInput.value = '';
        }

        // Hapus hasil regresi jika ada
        const resultContainer = document.getElementById('results');
        if (resultContainer) resultContainer.innerHTML = '';

        // Hapus chart jika ada
        if (window.regressionChartInstance) {
            window.regressionChartInstance.destroy();
            delete window.regressionChartInstance;
        }

        // Cek ulang apakah semua field terisi
        checkAllFieldsFilled(); // ⬅️ PENTING: Ini memicu tombol hitung muncul kembali jika sesuai
    };
</script>
</body>
</html>
